#!/usr/bin/env python

'''
geco-postprocess-multi-param-contactsheet

A script to compute velocity of particles as a function of radius

Required files: RHO_comp_i.xml.gz, mesh.xml.gz

Usage:

with setup.py installed in a docker container run

geco-postprocess-rotation_curves

from the directory that contains the solution directory(ies).
All subdirectories are assumed to have the same number of matter-species

'''
import sys
import geco_utils as gu
import argparse
import matplotlib.pyplot as plt
import matplotlib.gridspec as gridspec
import os
from itertools import izip
import post_process as sol

def DensityAndParameterContactSheet(row, r_max, res, fig, gs):
    subdir = os.getcwd()
    solution = sol.Solution(subdir, radius = r_max, resolution=res)

    for ndx, d_arr in enumerate(solution.density_arrays):
        f = fig.add_subplot(gs[row,ndx])
        f.imshow(d_arr, cmap='gist_heat', extent=(0,r_max,0,r_max),origin='lower')
        f.set_title(solution.titles_for_plot[ndx], fontsize=10)

    if (len(solution.density_arrays) == 1):
        text = "Radius of Support: {}\n{}".format(solution.radius_of_support[0],solution.parameter_str[0])
        t = plt.text(r_max*1.5, r_max/10,  text, fontsize=12)


###########################################################
def main(args):
    parser = argparse.ArgumentParser()
    parser.add_argument('-r', '--resolution', help="enter desired resolution of numpy arrays",
                            type=int, required=False)
    args=vars(parser.parse_args())

    res = 250 if args['resolution'] is None else args['resolution']

    file_list, dir_list = gu.FilesDirsByName('mesh.xml.gz')

    #Set up figure and spacing
    fig = plt.figure(figsize=(6,len(dir_list)*3.5))
    gs = gridspec.GridSpec(len(dir_list), 2)
    gs.update(wspace=0.5, hspace=0.25)

    r_max = gu.MaxSupport()
    print(r_max)
    top = os.getcwd()
    for row, sdir in enumerate(dir_list):
        print(sdir)
        os.chdir(sdir)
        DensityAndParameterContactSheet(row,r_max, res, fig, gs)
        os.chdir(top)

    fig.savefig("multi_param.png")

if __name__ == "__main__" :
    sys.exit(main(sys.argv))
